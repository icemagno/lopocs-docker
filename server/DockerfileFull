FROM kartoza/postgis
MAINTAINER magno.mabreu@gmail.com

# https://github.com/PDAL/data/tree/master/liblas

RUN apt-get update && apt-get install -y --no-install-recommends build-essential \
  make \
  cmake \
  g++ \
  libboost-dev \
  libboost-system-dev \
  libboost-filesystem-dev \
  libexpat1-dev \
  zlib1g-dev \
  libbz2-dev \
  libpq-dev \
  libproj-dev \
  lua5.2 \
  liblua5.2-dev \
  wget \
  software-properties-common \
  python3-setuptools \
  python3-matplotlib \
  python3-dev \
  python3-bs4 \
  python3-gdal \
  python3-pip \
  osmium-tool \
  curl \
  gdal-bin \
  git \
  libgdal-dev \
  sqlite3


RUN cd /home && git clone https://github.com/PDAL/PDAL.git && cd PDAL && mkdir build && cd build && cmake .. && make && make install

# https://github.com/Oslandia/pgmorton
RUN cd /home && git clone https://github.com/Oslandia/pgmorton && cd pgmorton && mkdir build && cd build && cmake .. && make && make install


# https://github.com/pgpointcloud/pointcloud/issues/231
RUN cd /home && git clone https://github.com/verma/laz-perf.git && cd laz-perf && mkdir build && cd build && cmake .. && make && make install
RUN ch /home && git clone https://github.com/pgpointcloud/pointcloud && cd pointcloud && ./autogen.sh && ./configure --with-lazperf=/usr/local/


RUN pip3 install 'Werkzeug==0.16.0' && \
  pip install 'numpy==1.16.0' && \
  pip3 install pdal


#  PointCloud is now configured for 

# -------------- Compiler Info ------------- 
#  C compiler:           gcc -g -O2
#  SQL preprocessor:     /usr/bin/cpp -traditional-cpp -w -P

# -------------- Dependencies -------------- 
#  PostgreSQL config:    /usr/bin/pg_config
#  PostgreSQL version:   PostgreSQL 12.3 (Debian 12.3-1.pgdg100+1) (120)
#  Libxml2 config:       /usr/bin/xml2-config
#  Libxml2 version:      2.9.4
#  LazPerf status:       /usr/local//include/laz-perf
#  CUnit status:         disabled

RUN wget http://download.osgeo.org/proj/proj-7.1.0.tar.gz && \
    tar -xvf proj-7.1.0.tar.gz && cd proj-7.1.0 && \
    ./configure && make && make install 
	
# Need to run: ln -s /usr/local/lib/libproj.so.19 /usr/lib/libproj.so.19	

RUN cd /home && git clone https://github.com/pyproj4/pyproj.git && cd pyproj && pip3 install -e .


# https://gitlab.com/Oslandia/lopocs#installation
RUN mkdir /lopocs/cache && cd /home && git clone https://github.com/Oslandia/lopocs

COPY ./setup.py /home/lopocs/
COPY ./lopocs.yml /home/lopocs/conf

RUN cd /home/lopocs && pip3 install -e .


# root@lopocs-db:/home/lopocs# lopocs check
# [2020-07-24 03:39:43,846] DEBUG in __init__: loading config from /home/lopocs/conf/lopocs.yml
# Pdal ... 2.1.0
# Pdal plugin pgpointcloud ... ok
# PostgreSQL ... 12.3 (Debian 12.3-1.pgdg100+1)
# PostGIS extension ... 3.0.1
# PgPointcloud extension ... 1.2.1
# PgPointcloud-PostGIS extension ... 1.2.1
  






  
  
  
  



